<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Blueprints</title>    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <style>
        .versions-form.bg-dark input,
        .versions-form.bg-dark textarea {
            background-color: #343a40;
            color: #fff;
            border: none;
        }
        .versions-row td {
            padding: 0 !important;
        }
        .versions-container {
            padding: 1rem;
            border-top: 1px solid #dee2e6;
            background-color: var(--table-accent-bg, #f8f9fa);
        }
        .table-hover tbody tr:hover {
            background-color: var(--table-hover-bg, rgba(0,0,0,.075));
        }
        .badge {
            font-size: 0.875em;
            padding: 0.35em 0.65em;
        }          /* Tab System Styles - Enhanced Visibility */        .blueprint-tabs {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 20px) !important;
            min-height: 600px;
            padding: 0;
            margin: 0;
        }
        
        .tab-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            border: 2px solid #495057;
            border-radius: 0.375rem;
            overflow: hidden;
            background-color: #212529;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            height: 100%;
            margin: 0;
            width: 100%;
        }.tab-header {
            display: flex !important;
            background: linear-gradient(135deg, #343a40 0%, #495057 100%) !important;
            border-bottom: 2px solid #6c757d !important;
            padding: 0.5rem 1rem !important;
            overflow-x: auto !important;
            white-space: nowrap !important;
            min-height: 40px !important;
            height: auto !important;
            align-items: stretch !important;
            box-shadow: inset 0 -1px 0 rgba(255, 255, 255, 0.1) !important;
            box-sizing: border-box !important;
            justify-content: space-between !important;
        }
        
        .tab-header-left {
            display: flex !important;
            align-items: stretch !important;
        }
        
        .tab-header-right {
            display: flex !important;
            align-items: center !important;
            margin-left: auto !important;
        }
        
        .create-blueprint-btn {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%) !important;
            border: none !important;
            color: white !important;
            padding: 0.5rem 1rem !important;
            border-radius: 0.375rem !important;
            font-size: 0.875rem !important;
            transition: all 0.3s ease !important;
        }
        
        .create-blueprint-btn:hover {
            background: linear-gradient(135deg, #218838 0%, #155724 100%) !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
        }        .tab {
            display: inline-flex !important;
            align-items: center !important;
            padding: 0.5rem 1rem !important;
            margin-right: 0.5rem !important;
            background: linear-gradient(135deg, #495057 0%, #6c757d 100%) !important;
            border: 2px solid #6c757d !important;
            border-radius: 0.375rem 0.375rem 0 0 !important;
            cursor: pointer !important;
            position: relative !important;
            color: #f8f9fa !important;
            font-weight: 500 !important;
            font-size: 0.875rem !important;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
            min-height: 35px !important;
            height: auto !important;
            line-height: 1.4 !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
            vertical-align: top !important;
            box-sizing: border-box !important;
            transform: translateY(0);
        }
          /* Enhanced visual separators between tabs */
        .tab:not(:last-child)::after {
            content: '';
            position: absolute;
            right: -0.25rem;
            top: 15%;
            height: 70%;
            width: 2px;
            background: linear-gradient(to bottom, 
                transparent 0%, 
                rgba(173, 181, 189, 0.3) 20%, 
                rgba(173, 181, 189, 0.8) 50%, 
                rgba(173, 181, 189, 0.3) 80%, 
                transparent 100%);
            z-index: 5;
            transition: opacity 0.3s ease, transform 0.3s ease;
            border-radius: 1px;
        }
        
        /* Hide separator on active tab and adjacent tabs for cleaner look */
        .tab.active::after,
        .tab.active + .tab::before,
        .tab:hover::after,
        .tab:hover + .tab::before {
            opacity: 0;
            transform: scaleY(0.5);
        }
          .tab:hover {
            background: linear-gradient(135deg, #5a6268 0%, #6c757d 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }.tab.active {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            border-color: #6c757d;
            border-bottom-color: #212529;
            margin-bottom: -2px;
            z-index: 10;
            color: #ffffff;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
            transform: translateY(0);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
          .tab.active:hover {
            background: linear-gradient(135deg, #5a6268 0%, #343a40 100%);
            transform: translateY(-1px);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }        .tab-close {
            margin-left: 0.5rem;
            opacity: 0.7;
            transition: opacity 0.2s;
            color: #f8f9fa;
        }
        
        /* Enhanced tab content animations */
        .tab-content {
            position: relative;
            overflow: hidden;
        }
        
        .tab-pane {
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform: translateY(0);
            opacity: 1;
        }
        
        .tab-pane:not(.active) {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
        }
        
        .tab-pane.active {
            position: relative;
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        
        .tab-close:hover {
            opacity: 1;
        }        .tab-content {
            flex: 1;
            overflow: auto;
            background-color: #212529;
            padding: 0 !important;
            color: #f8f9fa;
            height: calc(100vh - 80px) !important;
        }
        
        .table-responsive {
            height: 100% !important;
            margin: 0 !important;
            padding: 1rem !important;
            box-sizing: border-box !important;
        }
        
        .table {
            margin-bottom: 0 !important;
        }
        
        .tab-pane {
            display: none;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease-in-out;
        }
        
        .tab-pane.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Smooth tab switching animations */
        .tab-pane.fade-in {
            animation: tabFadeIn 0.3s ease-in-out;
        }
        
        .tab-pane.fade-out {
            animation: tabFadeOut 0.2s ease-in-out;
        }
        
        @keyframes tabFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes tabFadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-5px);
            }
        }
        
        /* Loading overlay and alerts */
        #loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
          #global-alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }        /* Main tab specific styling */
        .tab[data-tab-id="blueprint-main"] {
            border: 2px solid #6c757d !important;
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%) !important;
            min-height: 35px !important;
            font-size: 0.875rem !important;
            font-weight: bold !important;
            padding: 0.5rem 1rem !important;
        }
        
        .tab[data-tab-id="blueprint-main"] span {
            font-size: 1rem !important;
            color: #ffffff !important;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5) !important;
        }
        
        .tab[data-tab-id="blueprint-main"] i {
            font-size: 1.1rem !important;
            color: #ffffff !important;
        }
    </style>
</head>
<body>    <div layout:fragment="content">
        <div class="blueprint-tabs">
            <div class="alert alert-danger" th:if="${error != null}" th:text="${error}"></div>
            <div class="alert alert-success" th:if="${success != null}" th:text="${success}"></div>
            
            <!-- Tab Container -->
            <div class="tab-container">
                <!-- Tab Headers -->
                <div class="tab-header">
                    <div class="tab-header-left">
                        <div class="tab active" data-tab-id="blueprint-main">
                            <i class="fas fa-sitemap me-2"></i>
                            <span>Blueprints</span>
                        </div>
                    </div>
                    <div class="tab-header-right">
                        <button type="button" class="btn create-blueprint-btn" data-bs-toggle="modal" data-bs-target="#createBlueprintModal">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Blueprint Main Tab -->
                    <div class="tab-pane active" id="blueprint-main">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Description</th>
                                        <th>Version</th>
                                        <th>Created By</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                <tbody>
                    <tr th:if="${blueprints.empty}">
                        <td colspan="5" class="text-center">No blueprints found</td>
                    </tr>
                    <th:block th:each="blueprint : ${blueprints}">
                        <!-- Blueprint Row -->
                        <tr th:id="'blueprint-row-' + ${blueprint.id}" class="blueprint-row">
                            <td>
                                <button class="btn btn-link p-0" th:onclick="'toggleVersions(' + ${blueprint.id} + ')'" style="text-decoration: none;">
                                    <i class="fas fa-chevron-right me-2" th:id="'chevron-' + ${blueprint.id}"></i>
                                    <span th:text="${blueprint.name}"></span>
                                </button>
                            </td>
                            <td th:text="${blueprint.description}"></td>
                            <td th:text="${blueprint.activeVersion}"></td>
                            <td th:text="${blueprint.createdBy}"></td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-primary" th:onclick="'editBlueprint(' + ${blueprint.id} + ')'">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-success" th:onclick="'toggleVersions(' + ${blueprint.id} + ')'">
                                        <i class="fas fa-code-branch"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" th:onclick="'deleteBlueprint(' + ${blueprint.id} + ')'">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <!-- Versions Section -->
                        <tr th:id="'versions-row-' + ${blueprint.id}" class="versions-row d-none">
                            <td colspan="5" class="p-0">
                                <div class="versions-container bg-light">
                                    <!-- Create Version Form -->
                            <div class="versions-form bg-dark text-light rounded shadow">                                <h5 class="mb-3">Create New Version</h5>
                                <form id="createVersionForm" onsubmit="return false;">
                                    <input type="hidden" th:id="'versionBlueprintId-' + ${blueprint.id}" th:value="${blueprint.id}">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label for="name" class="form-label text-light">Name</label>
                                            <input type="text" class="form-control bg-secondary text-light border-0" id="name" name="name" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="description" class="form-label text-light">Description</label>
                                            <input type="text" class="form-control bg-secondary text-light border-0" id="description" name="description">
                                        </div>
                                        <div class="col-12">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="active" name="active">
                                                <label class="form-check-label text-light" for="active">Set as active version</label>
                                            </div>
                                        </div>
                                        <div class="col-12">                            <button type="submit" class="btn btn-primary" onclick="submitCreateBlueprintVersion(event)">
                                                Create Version
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                                    
                                    <!-- Loading Indicator -->
                                    <div class="versions-loading text-center d-none py-3">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Loading versions...</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Versions List -->
                                    <div class="versions-list"></div>
                                </div>
                            </td>
                        </tr>
                    </th:block>                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Additional tabs will be added dynamically -->
                </div>
            </div>

        <!-- Create Blueprint Modal -->
        <div class="modal fade" id="createBlueprintModal" tabindex="-1" aria-labelledby="createBlueprintModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="createBlueprintModalLabel">Create Blueprint</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="modalErrorAlert" class="alert alert-danger alert-dismissible fade show d-none">
                            <span id="errorMessage"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        <form id="createBlueprintForm" novalidate>
                            <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
                            <input type="hidden" name="_csrf_header" th:value="${_csrf.headerName}"/>
                            <div class="mb-3">
                                <label for="name" class="form-label">Name</label>
                                <input type="text" class="form-control" id="name" name="name" required autocomplete="off">
                            </div>
                            <div class="mb-3">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <input type="hidden" name="createdBy" value="system">
                            </div>
                            <div class="modal-footer px-0 pb-0">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" id="createButton" class="btn btn-primary">Create</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Blueprint Modal -->
        <div class="modal fade" id="editBlueprintModal" tabindex="-1" aria-labelledby="editBlueprintModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editBlueprintModalLabel">Edit Blueprint</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="editModalErrorAlert" class="alert alert-danger alert-dismissible fade show d-none">
                            <span id="editErrorMessage"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        <form id="editBlueprintForm" novalidate>
                            <input type="hidden" id="editBlueprintId" name="id">
                            <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
                            <input type="hidden" name="_csrf_header" th:value="${_csrf.headerName}"/>
                            <div class="mb-3">
                                <label for="editName" class="form-label">Name</label>
                                <input type="text" class="form-control" id="editName" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label for="editDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="editDescription" name="description" rows="3"></textarea>
                            </div>
                            <div class="modal-footer px-0 pb-0">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" id="updateButton" class="btn btn-primary">Update</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>        </div>    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="text-light ms-3" id="loading-message">Loading...</div>
    </div>
    
    <!-- Global Alert Container -->
    <div id="global-alert-container"></div>
    <!-- Page specific scripts -->
    <div layout:fragment="scripts">
        <!-- CRITICAL: Load Blueprint-specific scripts using deduplication system -->
        <script>
            // Load blueprint-specific scripts with deduplication
            document.addEventListener('DOMContentLoaded', function() {
                // Ensure script deduplication system is available
                if (typeof loadScriptOnce === 'function') {
                    console.log('%c[Blueprints] Loading scripts with deduplication...', 'color: #3498db; font-weight: bold;');
                    
                    Promise.all([
                        loadScriptOnce('/js/script-manager.js'),
                        loadScriptOnce('/js/deduplicated-tab-manager.js'),
                        loadScriptOnce('/js/blueprint-fixed.js')
                    ]).then(() => {
                        console.log('%c[Blueprints] All blueprint scripts loaded successfully', 'color: #27ae60; font-weight: bold;');
                        // Initialize blueprint functionality after scripts load
                        if (typeof initializeBlueprintFunctionality === 'function') {
                            initializeBlueprintFunctionality();
                        }
                    }).catch(error => {
                        console.error('[Blueprints] Error loading scripts:', error);
                        // Fallback initialization without additional scripts
                        console.log('%c[Blueprints] Proceeding with inline functionality only', 'color: #f39c12;');
                    });
                } else {
                    console.warn('%c[Blueprints] Script deduplication not available, proceeding with inline scripts only', 'color: #f39c12;');
                }
            });
        </script>
        
        <!-- CRITICAL: Robust Tab Structure Management with Enhanced Debugging -->
        <script>
            // Global tab structure management - available immediately
            window.BlueprintTabManager = (function() {
                
                // Enhanced debugging function to inspect DOM structure
                function debugDOMStructure(context = 'Unknown') {
                    console.log('%c[TabManager-DEBUG] ==================== DOM INSPECTION: ' + context + ' ====================', 'color: #2c3e50; font-weight: bold; background: #ecf0f1; padding: 2px;');
                    
                    // Check tab container
                    const tabContainer = document.querySelector('.tab-container');
                    console.log('%c[TabManager-DEBUG] Tab Container:', 'color: #3498db;', tabContainer);
                    if (tabContainer) {
                        console.log('  - Classes:', tabContainer.className);
                        console.log('  - Children count:', tabContainer.children.length);
                        console.log('  - innerHTML length:', tabContainer.innerHTML.length);
                        console.log('  - Display style:', getComputedStyle(tabContainer).display);
                        console.log('  - Visibility:', getComputedStyle(tabContainer).visibility);
                        
                        // Check each child
                        Array.from(tabContainer.children).forEach((child, index) => {
                            console.log(`  - Child ${index}:`, child.tagName, child.className, getComputedStyle(child).display);
                        });
                    }
                    
                    // Check tab header
                    const tabHeader = document.querySelector('.tab-header');
                    console.log('%c[TabManager-DEBUG] Tab Header:', 'color: #e67e22;', tabHeader);
                    if (tabHeader) {
                        console.log('  - Classes:', tabHeader.className);
                        console.log('  - Children count:', tabHeader.children.length);
                        console.log('  - Display style:', getComputedStyle(tabHeader).display);
                        console.log('  - Parent:', tabHeader.parentElement?.className);
                        
                        // Check tabs inside header
                        const tabs = tabHeader.querySelectorAll('.tab');
                        console.log('  - Tabs in header:', tabs.length);
                        tabs.forEach((tab, index) => {
                            console.log(`    - Tab ${index}:`, tab.getAttribute('data-tab-id'), tab.className, getComputedStyle(tab).display);
                        });
                    } else {
                        console.log('%c[TabManager-DEBUG] ‚ùå NO TAB HEADER FOUND!', 'color: #e74c3c; font-weight: bold;');
                    }
                    
                    // Check main tab specifically
                    const mainTab = document.querySelector('.tab[data-tab-id="blueprint-main"]');
                    console.log('%c[TabManager-DEBUG] Main Tab:', 'color: #27ae60;', mainTab);
                    if (mainTab) {
                        console.log('  - Classes:', mainTab.className);
                        console.log('  - Parent element:', mainTab.parentElement?.className);
                        console.log('  - Is in tab-header:', !!mainTab.closest('.tab-header'));
                        console.log('  - Display style:', getComputedStyle(mainTab).display);                        console.log('  - Position in DOM:', mainTab.getBoundingClientRect());
                        
                        // Run CSS diagnostics for the main tab
                        diagnoseCSSIssues(context + ' - Main Tab Found');
                        
                    } else {
                        console.log('%c[TabManager-DEBUG] ‚ùå NO MAIN TAB FOUND!', 'color: #e74c3c; font-weight: bold;');
                        
                        // Look for orphaned tabs
                        const allTabs = document.querySelectorAll('.tab');
                        console.log('  - All tabs found:', allTabs.length);
                        allTabs.forEach((tab, index) => {
                            console.log(`    - Orphaned tab ${index}:`, tab.getAttribute('data-tab-id'), tab.parentElement?.className);
                        });
                    }
                    
                    // Check tab content
                    const tabContent = document.querySelector('.tab-content');
                    console.log('%c[TabManager-DEBUG] Tab Content:', 'color: #9b59b6;', tabContent);
                    if (tabContent) {
                        console.log('  - Classes:', tabContent.className);
                        console.log('  - Children count:', tabContent.children.length);
                        console.log('  - Display style:', getComputedStyle(tabContent).display);
                    }
                    
                    // Check main pane
                    const mainPane = document.getElementById('blueprint-main');
                    console.log('%c[TabManager-DEBUG] Main Pane:', 'color: #16a085;', mainPane);
                    if (mainPane) {
                        console.log('  - Classes:', mainPane.className);
                        console.log('  - Display style:', getComputedStyle(mainPane).display);
                        console.log('  - Parent:', mainPane.parentElement?.className);
                    }
                      console.log('%c[TabManager-DEBUG] ==================== END DOM INSPECTION ====================', 'color: #2c3e50; font-weight: bold; background: #ecf0f1; padding: 2px;');
                }
                
                // CSS diagnostic function to analyze tab styling
                function diagnoseCSSIssues(context = 'Unknown') {
                    console.log('%c[CSS-DIAGNOSTIC] ==================== CSS ANALYSIS: ' + context + ' ====================', 'color: #8e44ad; font-weight: bold; background: #f4f3ff; padding: 2px;');
                    
                    const mainTab = document.querySelector('.tab[data-tab-id="blueprint-main"]');
                    if (mainTab) {
                        const computedStyle = getComputedStyle(mainTab);
                        const rect = mainTab.getBoundingClientRect();
                        
                        console.log('%c[CSS-DIAGNOSTIC] Main Tab Computed Styles:', 'color: #8e44ad; font-weight: bold;');
                        console.log('  - width:', computedStyle.width, '(computed) vs', rect.width, '(actual)');
                        console.log('  - height:', computedStyle.height, '(computed) vs', rect.height, '(actual)');
                        console.log('  - min-height:', computedStyle.minHeight);
                        console.log('  - max-height:', computedStyle.maxHeight);
                        console.log('  - line-height:', computedStyle.lineHeight);
                        console.log('  - padding:', computedStyle.padding);
                        console.log('  - margin:', computedStyle.margin);
                        console.log('  - border:', computedStyle.border);
                        console.log('  - box-sizing:', computedStyle.boxSizing);
                        console.log('  - display:', computedStyle.display);
                        console.log('  - position:', computedStyle.position);
                        console.log('  - vertical-align:', computedStyle.verticalAlign);
                        console.log('  - overflow:', computedStyle.overflow);
                        console.log('  - font-size:', computedStyle.fontSize);
                        console.log('  - font-weight:', computedStyle.fontWeight);
                        
                        // Check for conflicting styles
                        console.log('%c[CSS-DIAGNOSTIC] Style Conflict Analysis:', 'color: #8e44ad; font-weight: bold;');
                        
                        // Check if min-height is being overridden
                        if (parseInt(computedStyle.height) < 45) {
                            console.log('%c[CSS-DIAGNOSTIC] ‚ö†Ô∏è HEIGHT ISSUE: Computed height (' + computedStyle.height + ') is less than expected min-height (45px)', 'color: #e74c3c; font-weight: bold;');
                            
                            // Check parent constraints
                            const parent = mainTab.parentElement;
                            if (parent) {
                                const parentStyle = getComputedStyle(parent);
                                console.log('  - Parent height:', parentStyle.height);
                                console.log('  - Parent overflow:', parentStyle.overflow);
                                console.log('  - Parent display:', parentStyle.display);
                                console.log('  - Parent align-items:', parentStyle.alignItems);
                            }
                        }
                        
                        // Check CSS rule sources
                        console.log('%c[CSS-DIAGNOSTIC] CSS Rule Sources:', 'color: #8e44ad; font-weight: bold;');
                        const stylesheets = Array.from(document.styleSheets);
                        stylesheets.forEach((sheet, index) => {
                            try {
                                const rules = Array.from(sheet.cssRules || sheet.rules || []);
                                const tabRules = rules.filter(rule => 
                                    rule.selectorText && 
                                    (rule.selectorText.includes('.tab') || 
                                     rule.selectorText.includes('[data-tab-id="blueprint-main"]'))
                                );
                                if (tabRules.length > 0) {
                                    console.log(`  - Stylesheet ${index} (${sheet.href || 'inline'}):`, tabRules.length, 'relevant rules');
                                    tabRules.forEach(rule => {
                                        console.log(`    - ${rule.selectorText}:`, rule.style.minHeight || 'no min-height', rule.style.height || 'no height');
                                    });
                                }
                            } catch (e) {
                                console.log(`  - Stylesheet ${index}: Unable to access (CORS)`);
                            }
                        });
                        
                    } else {
                        console.log('%c[CSS-DIAGNOSTIC] ‚ùå Main tab not found for CSS analysis', 'color: #e74c3c; font-weight: bold;');
                    }
                    
                    console.log('%c[CSS-DIAGNOSTIC] ==================== END CSS ANALYSIS ====================', 'color: #8e44ad; font-weight: bold; background: #f4f3ff; padding: 2px;');
                }
                
                // Hide loading overlay immediately
                function hideLoadingOverlay() {
                    const loadingOverlay = document.getElementById('loading-overlay');
                    if (loadingOverlay) {
                        loadingOverlay.style.display = 'none';
                        console.log('%c[TabManager] Loading overlay hidden', 'color: #27ae60;');
                    }
                }
                
                // Comprehensive tab structure validation and repair
                function validateAndRepairTabStructure() {
                    console.log('%c[TabManager] ========================================', 'color: #3498db; font-weight: bold;');
                    console.log('%c[TabManager] STARTING TAB STRUCTURE VALIDATION', 'color: #3498db; font-weight: bold;');
                    console.log('%c[TabManager] ========================================', 'color: #3498db; font-weight: bold;');
                    
                    debugDOMStructure('Before Validation');
                    
                    const tabContainer = document.querySelector('.tab-container');
                    if (!tabContainer) {
                        console.error('%c[TabManager] ‚ùå CRITICAL: No tab container found!', 'color: #e74c3c; font-weight: bold;');
                        debugDOMStructure('No Tab Container');
                        return false;
                    }
                    
                    let tabHeader = tabContainer.querySelector('.tab-header');
                    let tabContent = tabContainer.querySelector('.tab-content');
                    let mainTab = document.querySelector('.tab[data-tab-id="blueprint-main"]');
                    let mainPane = document.getElementById('blueprint-main');
                    
                    console.log('%c[TabManager] Initial elements found:', 'color: #3498db;');
                    console.log('  - Tab Container:', !!tabContainer);
                    console.log('  - Tab Header:', !!tabHeader);
                    console.log('  - Tab Content:', !!tabContent);
                    console.log('  - Main Tab:', !!mainTab);
                    console.log('  - Main Pane:', !!mainPane);
                    
                    // Create missing tab-header if needed
                    if (!tabHeader) {
                        console.log('%c[TabManager] üîß Creating missing tab-header', 'color: #f39c12; font-weight: bold;');
                        tabHeader = document.createElement('div');
                        tabHeader.className = 'tab-header';
                        tabContainer.insertBefore(tabHeader, tabContainer.firstChild);
                        console.log('%c[TabManager] ‚úÖ Tab header created and inserted', 'color: #27ae60;');
                        debugDOMStructure('After Tab Header Creation');
                    }
                    
                    // Create missing tab-content if needed
                    if (!tabContent) {
                        console.log('%c[TabManager] üîß Creating missing tab-content', 'color: #f39c12; font-weight: bold;');
                        tabContent = document.createElement('div');
                        tabContent.className = 'tab-content';
                        tabContainer.appendChild(tabContent);
                        console.log('%c[TabManager] ‚úÖ Tab content created and appended', 'color: #27ae60;');
                        debugDOMStructure('After Tab Content Creation');
                    }
                    
                    // Handle orphaned main tab
                    if (mainTab && !mainTab.closest('.tab-header')) {
                        console.log('%c[TabManager] üîß FIXING ORPHANED MAIN TAB', 'color: #e67e22; font-weight: bold;');
                        console.log('  - Current parent:', mainTab.parentElement?.className || 'none');
                        console.log('  - Current position:', mainTab.getBoundingClientRect());
                        
                        // Remove the orphaned tab from its current location
                        const oldParent = mainTab.parentElement;
                        mainTab.remove();
                        console.log('  - Removed from old parent:', oldParent?.className || 'none');
                        
                        // Create a proper main tab in the tab-header
                        const newMainTab = document.createElement('div');
                        newMainTab.className = 'tab active';
                        newMainTab.setAttribute('data-tab-id', 'blueprint-main');
                        newMainTab.innerHTML = `
                            <i class="fas fa-sitemap me-2"></i>
                            <span>Blueprints</span>
                        `;
                        
                        tabHeader.appendChild(newMainTab);
                        mainTab = newMainTab;
                        
                        console.log('%c[TabManager] ‚úÖ Recreated main tab in proper location', 'color: #27ae60; font-weight: bold;');
                        debugDOMStructure('After Main Tab Fix');
                    } else if (!mainTab) {
                        console.log('%c[TabManager] üîß CREATING MISSING MAIN TAB', 'color: #e67e22; font-weight: bold;');
                        
                        // Create a proper main tab in the tab-header
                        const newMainTab = document.createElement('div');
                        newMainTab.className = 'tab active';
                        newMainTab.setAttribute('data-tab-id', 'blueprint-main');
                        newMainTab.innerHTML = `
                            <i class="fas fa-sitemap me-2"></i>
                            <span>Blueprints</span>
                        `;
                        
                        tabHeader.appendChild(newMainTab);
                        mainTab = newMainTab;
                        
                        console.log('%c[TabManager] ‚úÖ Created new main tab', 'color: #27ae60; font-weight: bold;');
                        debugDOMStructure('After Main Tab Creation');
                    } else {
                        console.log('%c[TabManager] ‚úÖ Main tab is correctly positioned in tab-header', 'color: #27ae60;');
                    }
                    
                    // Handle missing main pane
                    if (!mainPane && tabContent) {
                        console.log('%c[TabManager] üîß Main pane missing, finding content...', 'color: #f39c12; font-weight: bold;');
                        
                        // Look for the blueprint table content
                        const blueprintTable = document.querySelector('.table-responsive');
                        if (blueprintTable) {
                            // Create main pane and move content into it
                            mainPane = document.createElement('div');
                            mainPane.className = 'tab-pane active';
                            mainPane.id = 'blueprint-main';
                            
                            // Move all content that should be in the main tab
                            const contentElements = [
                                document.querySelector('.table-responsive'),                                ...document.querySelectorAll('.modal') // Include modals
                            ].filter(el => el);
                            
                            contentElements.forEach(el => {
                                mainPane.appendChild(el);
                            });
                            
                            tabContent.appendChild(mainPane);
                            console.log('%c[TabManager] ‚úÖ Created and populated main pane', 'color: #27ae60; font-weight: bold;');
                            debugDOMStructure('After Main Pane Creation');
                        }
                    }
                    
                    // Ensure proper event handlers for main tab
                    if (mainTab && !mainTab.hasAttribute('data-event-attached')) {
                        mainTab.addEventListener('click', function() {
                            console.log('%c[TabManager] Main tab clicked, activating...', 'color: #3498db;');
                            activateMainTab();
                        });
                        mainTab.setAttribute('data-event-attached', 'true');
                        console.log('%c[TabManager] ‚úÖ Attached event handler to main tab', 'color: #27ae60;');
                    }
                    
                    // Final validation check
                    const finalTabHeader = document.querySelector('.tab-header');
                    const finalMainTab = document.querySelector('.tab[data-tab-id="blueprint-main"]');
                    const finalMainPane = document.getElementById('blueprint-main');
                    
                    const isValid = finalTabHeader && finalMainTab && finalMainTab.closest('.tab-header') && finalMainPane;
                    
                    console.log('%c[TabManager] ========================================', 'color: #3498db; font-weight: bold;');
                    console.log('%c[TabManager] VALIDATION RESULT: ' + (isValid ? 'SUCCESS' : 'FAILED'), isValid ? 'color: #27ae60; font-weight: bold;' : 'color: #e74c3c; font-weight: bold;');
                    console.log('%c[TabManager] ========================================', 'color: #3498db; font-weight: bold;');
                    
                    if (!isValid) {
                        debugDOMStructure('Validation Failed');
                    } else {
                        debugDOMStructure('Validation Successful');
                    }
                    
                    return isValid;
                }
                
                // Activate the main blueprint tab
                function activateMainTab() {
                    console.log('%c[TabManager] ================', 'color: #2ecc71; font-weight: bold;');
                    console.log('%c[TabManager] ACTIVATING MAIN TAB', 'color: #2ecc71; font-weight: bold;');
                    console.log('%c[TabManager] ================', 'color: #2ecc71; font-weight: bold;');
                    
                    debugDOMStructure('Before Main Tab Activation');
                    
                    // Remove active from all tabs and panes
                    document.querySelectorAll('.tab, .tab-pane').forEach(el => {
                        el.classList.remove('active');
                    });
                    
                    // Activate main tab and pane
                    const mainTab = document.querySelector('.tab[data-tab-id="blueprint-main"]');
                    const mainPane = document.getElementById('blueprint-main');
                    
                    if (mainTab) {
                        mainTab.classList.add('active');
                        console.log('%c[TabManager] ‚úÖ Main tab activated', 'color: #27ae60;');
                    } else {
                        console.error('%c[TabManager] ‚ùå Could not find main tab to activate!', 'color: #e74c3c; font-weight: bold;');
                    }
                    
                    if (mainPane) {
                        mainPane.classList.add('active');
                        console.log('%c[TabManager] ‚úÖ Main pane activated', 'color: #27ae60;');
                    } else {
                        console.error('%c[TabManager] ‚ùå Could not find main pane to activate!', 'color: #e74c3c; font-weight: bold;');
                    }
                    
                    // Update global activeTabId if available
                    if (window.activeTabId !== undefined) {
                        window.activeTabId = 'blueprint-main';
                        console.log('%c[TabManager] ‚úÖ Updated global activeTabId', 'color: #27ae60;');
                    }
                    
                    debugDOMStructure('After Main Tab Activation');
                }
                
                // Enhanced timing analysis for initialization
                function performTimingAnalysis() {
                    console.log('%c[TabManager] ==================== TIMING ANALYSIS ====================', 'color: #8e44ad; font-weight: bold;');
                    
                    // Check document ready state
                    console.log('%c[TabManager] Document ready state:', 'color: #8e44ad;', document.readyState);
                    console.log('%c[TabManager] Performance timing available:', 'color: #8e44ad;', !!performance.timing);
                    
                    if (performance.timing) {
                        const timing = performance.timing;
                        const domContentLoaded = timing.domContentLoadedEventEnd - timing.navigationStart;
                        const fullLoad = timing.loadEventEnd - timing.navigationStart;
                        
                        console.log('%c[TabManager] DOM Content Loaded:', 'color: #8e44ad;', domContentLoaded + 'ms');
                        console.log('%c[TabManager] Full Load:', 'color: #8e44ad;', fullLoad + 'ms');
                    }
                    
                    // Check if scripts are loaded
                    const scriptsLoaded = {
                        ScriptManager: !!window.ScriptManager,
                        DeduplicatedTabManager: !!window.DeduplicatedTabManager,
                        TabStateManager: !!window.TabStateManager,
                        viewVersionDetail: typeof window.viewVersionDetail === 'function',
                        createNewTab: typeof window.createNewTab === 'function',
                        activateTab: typeof window.activateTab === 'function'
                    };
                    
                    console.log('%c[TabManager] Scripts loaded status:', 'color: #8e44ad;', scriptsLoaded);
                    
                    // Check SPA/MPA context
                    console.log('%c[TabManager] SPA Router available:', 'color: #8e44ad;', !!window.SPARouter);
                    console.log('%c[TabManager] Page Cache available:', 'color: #8e44ad;', !!window.PageCache);
                    
                    console.log('%c[TabManager] ==================== END TIMING ANALYSIS ====================', 'color: #8e44ad; font-weight: bold;');
                }
                
                // Comprehensive initialization with multiple retry attempts
                function initialize() {
                    console.log('%c[TabManager] ================================================', 'color: #2c3e50; font-weight: bold;');
                    console.log('%c[TabManager] INITIALIZING BLUEPRINT TAB MANAGEMENT SYSTEM', 'color: #2c3e50; font-weight: bold;');
                    console.log('%c[TabManager] ================================================', 'color: #2c3e50; font-weight: bold;');
                    
                    performTimingAnalysis();
                    hideLoadingOverlay();
                    
                    // Enhanced validation with multiple attempts
                    const maxAttempts = 10;
                    let attempts = 0;
                    let lastStructureState = null;
                    
                    function attemptRepair() {
                        attempts++;
                        console.log('%c[TabManager] ================================', 'color: #3498db; font-weight: bold;');
                        console.log('%c[TabManager] STRUCTURE REPAIR ATTEMPT ' + attempts + '/' + maxAttempts, 'color: #3498db; font-weight: bold;');
                        console.log('%c[TabManager] ================================', 'color: #3498db; font-weight: bold;');
                        
                        const currentState = {
                            hasTabContainer: !!document.querySelector('.tab-container'),
                            hasTabHeader: !!document.querySelector('.tab-header'),
                            hasMainTab: !!document.querySelector('.tab[data-tab-id="blueprint-main"]'),
                            mainTabInHeader: !!document.querySelector('.tab-header .tab[data-tab-id="blueprint-main"]'),
                            hasMainPane: !!document.getElementById('blueprint-main'),
                            documentReady: document.readyState
                        };
                        
                        console.log('%c[TabManager] Current structure state:', 'color: #3498db;', currentState);
                        
                        if (lastStructureState) {
                            const stateChanged = JSON.stringify(currentState) !== JSON.stringify(lastStructureState);
                            console.log('%c[TabManager] Structure changed since last attempt:', 'color: #3498db;', stateChanged);
                        }
                        lastStructureState = currentState;
                        
                        if (validateAndRepairTabStructure()) {
                            activateMainTab();
                            console.log('%c[TabManager] ‚úÖ SUCCESS: Tab structure validated and main tab activated', 'color: #27ae60; font-weight: bold;');
                            
                            // Verify the fix persists with delayed checks
                            setTimeout(() => {
                                const headerCheck = document.querySelector('.tab[data-tab-id="blueprint-main"]')?.closest('.tab-header');
                                if (!headerCheck) {
                                    console.log('%c[TabManager] ‚ö†Ô∏è Structure corrupted again after 100ms, re-repairing...', 'color: #e74c3c; font-weight: bold;');
                                    debugDOMStructure('Structure Corrupted Again');
                                    validateAndRepairTabStructure();
                                    activateMainTab();
                                } else {
                                    console.log('%c[TabManager] ‚úÖ Structure verification passed after 100ms', 'color: #27ae60;');
                                }
                            }, 100);
                            
                            setTimeout(() => {
                                const headerCheck = document.querySelector('.tab[data-tab-id="blueprint-main"]')?.closest('.tab-header');
                                if (!headerCheck) {
                                    console.log('%c[TabManager] ‚ö†Ô∏è Structure corrupted again after 500ms, final repair...', 'color: #e74c3c; font-weight: bold;');
                                    debugDOMStructure('Structure Corrupted After 500ms');
                                    validateAndRepairTabStructure();
                                    activateMainTab();
                                } else {
                                    console.log('%c[TabManager] ‚úÖ Structure verification passed after 500ms', 'color: #27ae60;');
                                }
                            }, 500);
                            
                        } else if (attempts < maxAttempts) {
                            const delay = Math.min(50 * attempts, 500); // Progressive delay
                            console.log('%c[TabManager] ‚è≥ Retrying in ' + delay + 'ms...', 'color: #f39c12;');
                            setTimeout(attemptRepair, delay);
                        } else {
                            console.error('%c[TabManager] ‚ùå FAILED: Could not repair tab structure after ' + maxAttempts + ' attempts', 'color: #e74c3c; font-weight: bold;');
                            debugDOMStructure('Final Failed State');
                            
                            // Try one last desperate attempt with DOM mutation observer
                            console.log('%c[TabManager] üîÑ Attempting DOM mutation observer fallback...', 'color: #e67e22; font-weight: bold;');
                            setupDOMMutationObserver();
                        }
                    }
                    
                    // Start repair process based on document state
                    if (document.readyState === 'loading') {
                        console.log('%c[TabManager] ‚è≥ Document still loading, waiting for DOMContentLoaded...', 'color: #f39c12;');
                        document.addEventListener('DOMContentLoaded', attemptRepair);
                    } else {
                        console.log('%c[TabManager] ‚úÖ Document ready, starting repair immediately...', 'color: #27ae60;');
                        attemptRepair();
                    }
                    
                    // Listen for SPA navigation to re-validate structure
                    document.addEventListener('spa:afterNavigation', function(e) {
                        if (e.detail.path === '/blueprints') {
                            console.log('%c[TabManager] üöÄ SPA navigation to blueprints detected, re-validating structure...', 'color: #3498db; font-weight: bold;');
                            performTimingAnalysis();
                            setTimeout(() => {
                                debugDOMStructure('After SPA Navigation');
                                validateAndRepairTabStructure();
                                activateMainTab();
                            }, 50);
                        }
                    });
                }
                
                // DOM Mutation Observer as fallback for persistent issues
                function setupDOMMutationObserver() {
                    if (!window.MutationObserver) {
                        console.error('%c[TabManager] MutationObserver not available', 'color: #e74c3c;');
                        return;
                    }
                    
                    const observer = new MutationObserver(function(mutations) {
                        let shouldCheck = false;
                        mutations.forEach(function(mutation) {
                            if (mutation.type === 'childList' && 
                                (mutation.target.matches('.tab-container') || 
                                 mutation.target.matches('.tab-header') ||
                                 mutation.target.matches('body'))) {
                                shouldCheck = true;
                            }
                        });
                        
                        if (shouldCheck) {
                            console.log('%c[TabManager] üîç DOM mutations detected, checking tab structure...', 'color: #9b59b6;');
                            
                            const mainTabInHeader = document.querySelector('.tab-header .tab[data-tab-id="blueprint-main"]');
                            if (!mainTabInHeader) {
                                console.log('%c[TabManager] üîÑ Main tab not in header, triggering repair...', 'color: #e67e22;');
                                setTimeout(() => {
                                    validateAndRepairTabStructure();
                                    activateMainTab();
                                }, 10);
                            }
                        }
                    });
                    
                    observer.observe(document.body, {
                        childList: true,
                        subtree: true
                    });
                    
                    console.log('%c[TabManager] ‚úÖ DOM Mutation Observer setup complete', 'color: #27ae60;');
                }
                
                return {
                    initialize,
                    validateAndRepairTabStructure,
                    activateMainTab,
                    hideLoadingOverlay,
                    debugDOMStructure,
                    performTimingAnalysis
                };
            })();
            
            // Initialize immediately
            window.BlueprintTabManager.initialize();
        </script>        <!-- Load script deduplication system first -->
        <script th:src="@{/js/script-deduplication.js}"></script>
        
        <!-- Load script manager with deduplication -->
        <script>
            // Use the new deduplication system
            window.loadScriptOnce('/js/script-manager.js', 'ScriptManager').then(() => {
                return window.loadScriptOnce('/js/deduplicated-tab-manager.js', 'DeduplicatedTabManager');
            }).then(() => {
                return window.loadScriptOnce('/js/tab-state-manager.js', 'TabStateManager');
            }).then(() => {
                return window.loadScriptOnce('/js/blueprint-globals.js', null, true); // Force reload for page-specific scripts
            }).then(() => {
                return window.loadScriptOnce('/js/blueprint-fixed.js', null, true);
            }).then(() => {
                return window.loadScriptOnce('/js/blueprint-version-fixed.js', null, true);
            }).then(() => {
                console.log('%c[Blueprint Scripts] All scripts loaded without conflicts', 'color: #27ae60; font-weight: bold;');
                
                // Final tab structure validation after all scripts load
                setTimeout(function() {
                    if (window.BlueprintTabManager) {
                        window.BlueprintTabManager.validateAndRepairTabStructure();
                        window.BlueprintTabManager.activateMainTab();
                    }
                }, 100);
            }).catch(error => {
                console.error('%c[Blueprint Scripts] Error loading scripts:', 'color: #e74c3c;', error);
            });
        </script>
        
        <!-- Tab System JavaScript -->
        <script>
            // Expose tabContentCache globally
            window.tabContentCache = new Map();
            let activeTabId = 'blueprint-main';
            let tabCounter = 0;
              // Tab System Functions with Enhanced Animations
            window.activateTab = function(tabId) {
                console.log('Activating tab:', tabId);
                
                // Get current active elements
                const currentActiveTab = document.querySelector('.tab.active');
                const currentActivePane = document.querySelector('.tab-pane.active');
                
                // Get target elements
                const targetTab = document.querySelector(`.tab[data-tab-id="${tabId}"]`);
                const targetPane = document.getElementById(tabId);
                
                if (!targetTab || !targetPane) {
                    console.error('Tab or pane not found:', tabId);
                    return;
                }
                
                // Add fade-out animation to current pane
                if (currentActivePane && currentActivePane !== targetPane) {
                    currentActivePane.style.opacity = '0';
                    currentActivePane.style.transform = 'translateY(10px)';
                    currentActivePane.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
                }
                
                // Remove active class from all tabs and panes after animation starts
                setTimeout(() => {
                    document.querySelectorAll('.tab, .tab-pane').forEach(el => {
                        el.classList.remove('active');
                    });
                    
                    // Add active class to target elements
                    targetTab.classList.add('active');
                    targetPane.classList.add('active');
                    
                    // Add fade-in animation to target pane
                    targetPane.style.opacity = '0';
                    targetPane.style.transform = 'translateY(-10px)';
                    targetPane.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    
                    // Trigger reflow and animate in
                    targetPane.offsetHeight;
                    targetPane.style.opacity = '1';
                    targetPane.style.transform = 'translateY(0)';
                    
                    activeTabId = tabId;
                    
                    // Save tabs state to session storage
                    saveTabsToSessionStorage();
                    
                    // Scroll the tab into view with smooth animation
                    targetTab.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'nearest', 
                        inline: 'center' 
                    });
                    
                    // Dispatch a custom event
                    document.dispatchEvent(new CustomEvent('tab:activated', {
                        detail: { tabId }
                    }));
                }, 100);
            }
            
            function closeTab(tabId) {
                // Don't allow closing the main tab
                if (tabId === 'blueprint-main') {
                    return;
                }
                
                const tab = document.querySelector(`.tab[data-tab-id="${tabId}"]`);
                const pane = document.getElementById(tabId);
                
                if (tab && pane) {
                    // If this was the active tab, activate the main tab
                    if (activeTabId === tabId) {
                        activateTab('blueprint-main');
                    }
                    
                    // Remove the tab and pane
                    tab.remove();
                    pane.remove();
                      // Remove from cache
                    tabContentCache.delete(tabId);
                    
                    // Save updated tabs state to session storage
                    saveTabsToSessionStorage();
                    
                    // Dispatch a custom event
                    document.dispatchEvent(new CustomEvent('tab:closed', {
                        detail: { tabId }
                    }));
                }
            }
            
            window.createNewTab = function(tabId, title, content, iconName, versionId = null) {
                // Check if the tab already exists
                const existingTab = document.querySelector(`.tab[data-tab-id="${tabId}"]`);
                const existingPane = document.getElementById(tabId);
                
                if (existingTab && existingPane) {
                    // Update the content if the tab already exists
                    existingPane.innerHTML = content;
                    activateTab(tabId);
                    return;
                }                  // Create the tab element
                const tabHeaderLeft = document.querySelector('.tab-header-left');
                const newTab = document.createElement('div');
                newTab.className = 'tab';
                newTab.setAttribute('data-tab-id', tabId);
                if (versionId) {
                    newTab.setAttribute('data-version-id', versionId);
                }
                newTab.innerHTML = `
                    <i class="fas ${iconName} me-2"></i>
                    <span>${title}</span>
                    <span class="tab-close" title="Close tab">√ó</span>
                `;
                
                // Insert new tab after the main blueprint tab instead of appending to the end
                const mainTab = document.querySelector('.tab[data-tab-id="blueprint-main"]');
                if (mainTab && tabHeaderLeft) {
                    // Get the main tab's next sibling within the same parent container
                    const nextSibling = mainTab.nextSibling;
                    if (nextSibling) {
                        // Insert before the next sibling (effectively after the main tab)
                        tabHeaderLeft.insertBefore(newTab, nextSibling);
                    } else {
                        // Main tab is the last element, append after it
                        tabHeaderLeft.appendChild(newTab);
                    }
                } else {
                    // Fallback: append to the tab-header-left container
                    if (tabHeaderLeft) {
                        tabHeaderLeft.appendChild(newTab);
                    } else {
                        // Last resort: fallback to tab-header
                        const tabHeader = document.querySelector('.tab-header');
                        if (tabHeader) {
                            tabHeader.appendChild(newTab);
                        }
                    }
                }
                
                // Create the tab pane
                const tabContent = document.querySelector('.tab-content');
                const newPane = document.createElement('div');
                newPane.className = 'tab-pane';
                newPane.id = tabId;
                newPane.innerHTML = content;
                tabContent.appendChild(newPane);
                
                // Setup event listeners for the new tab
                newTab.addEventListener('click', function(event) {
                    // Don't activate the tab if the close button was clicked
                    if (!event.target.closest('.tab-close')) {
                        activateTab(tabId);
                    }
                });
                
                // Setup close button
                const closeButton = newTab.querySelector('.tab-close');
                if (closeButton) {
                    closeButton.addEventListener('click', function(event) {
                        event.stopPropagation();
                        closeTab(tabId);
                    });
                }
                
                // Activate the new tab
                activateTab(tabId);
            }
            
            function initializeTabScripts(tabId, versionId) {
                // This function can be expanded to initialize any scripts needed for specific tabs
                console.log(`Initializing scripts for tab ${tabId} with versionId ${versionId}`);
                
                // Example: If the tab contains form elements, you might initialize them here
                const tab = document.getElementById(tabId);
                if (tab) {
                    const forms = tab.querySelectorAll('form');
                    forms.forEach(form => {
                        console.log('Found form in tab:', form.id || 'unnamed form');
                    });
                }
            }
              // Utility functions for loading indicator and alerts
            window.showLoading = function(message) {
                // Add a small delay to prevent showing loading on initial page load
                if (document.readyState === 'loading') {
                    console.log('%c[Loading] Ignoring showLoading during page load', 'color: #f39c12;');
                    return;
                }
                
                const loadingOverlay = document.getElementById('loading-overlay');
                if (!loadingOverlay) {
                    // Create the loading overlay if it doesn't exist
                    const overlay = document.createElement('div');
                    overlay.id = 'loading-overlay';
                    overlay.style.display = 'flex';
                    overlay.innerHTML = `
                        <div class="spinner-border text-light" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="text-light ms-3" id="loading-message">${message || 'Loading...'}</div>
                    `;
                    document.body.appendChild(overlay);
                } else {
                    // Update the message and show the existing overlay
                    const loadingMessage = document.getElementById('loading-message');
                    if (loadingMessage) {
                        loadingMessage.textContent = message || 'Loading...';
                    }
                    loadingOverlay.style.display = 'flex';
                }
                console.log('%c[Loading] Showing loading overlay:', 'color: #3498db;', message);
            }
            
            window.hideLoading = function() {
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                    console.log('%c[Loading] Loading overlay hidden', 'color: #27ae60;');
                }
                
                // Also ensure any dynamically created overlays are hidden
                document.querySelectorAll('#loading-overlay').forEach(overlay => {
                    overlay.style.display = 'none';
                });
            }
            
            window.showError = function(message) {
                // Hide loading first
                hideLoading();
                
                // Create or get the alert container
                let alertContainer = document.getElementById('global-alert-container');
                if (!alertContainer) {
                    alertContainer = document.createElement('div');
                    alertContainer.id = 'global-alert-container';
                    alertContainer.className = 'position-fixed top-0 end-0 p-3';
                    alertContainer.style.zIndex = 1050;
                    document.body.appendChild(alertContainer);
                }
                
                // Create alert element
                const alertId = 'alert-' + Date.now();
                const alertEl = document.createElement('div');
                alertEl.className = 'alert alert-danger alert-dismissible fade show';
                alertEl.id = alertId;
                alertEl.innerHTML = `
                    <strong>Error!</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                // Add to container
                alertContainer.appendChild(alertEl);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    const alert = document.getElementById(alertId);
                    if (alert) {
                        alert.classList.remove('show');
                        setTimeout(() => alert.remove(), 150);
                    }
                }, 5000);
            }            // Global function to ensure tab structure integrity
            window.ensureTabStructureIntegrity = function() {
                const tabContainer = document.querySelector('.tab-container');
                if (!tabContainer) {
                    console.error('%c[Tab System] Tab container not found!', 'color: #e74c3c;');
                    return false;
                }
                
                let tabHeader = tabContainer.querySelector('.tab-header');
                let mainTab = document.querySelector('.tab[data-tab-id="blueprint-main"]');
                let mainPane = document.getElementById('blueprint-main');
                
                // Create tab-header if missing
                if (!tabHeader) {
                    console.log('%c[Tab System] Creating missing tab-header', 'color: #f39c12;');
                    tabHeader = document.createElement('div');
                    tabHeader.className = 'tab-header';
                    tabContainer.insertBefore(tabHeader, tabContainer.firstChild);
                }
                
                // Ensure main tab is in the tab-header
                if (mainTab && !mainTab.closest('.tab-header')) {
                    console.log('%c[Tab System] Moving main tab to tab-header', 'color: #f39c12;');
                    tabHeader.appendChild(mainTab);
                }
                
                // Verify tab structure
                if (!mainTab || !mainPane) {
                    console.error('%c[Tab System] Main tab elements missing!', 'color: #e74c3c;');
                    return false;
                }
                
                console.log('%c[Tab System] Tab structure integrity verified', 'color: #27ae60;');
                return true;
            };
            
            // Enhanced initialization system
            document.addEventListener('DOMContentLoaded', function() {
                console.log('%c[Tab System] Initializing...', 'color: #27ae60; font-weight: bold;');
                
                // CRITICAL: Hide loading overlay immediately on page load
                hideLoading();
                
                // Wait for all scripts to load before initializing
                const initializeTabSystem = () => {
                    // Ensure tab structure integrity first
                    if (!ensureTabStructureIntegrity()) {
                        setTimeout(initializeTabSystem, 50);
                        return;
                    }
                    
                    // Ensure loading overlay is hidden
                    hideLoading();
                    
                    // Cache the main blueprint tab content
                    const mainPane = document.getElementById('blueprint-main');
                    if (mainPane) {
                        tabContentCache.set('blueprint-main', {
                            title: 'Blueprints',
                            content: mainPane.innerHTML,
                            icon: 'fa-sitemap'
                        });
                    }
                    
                    // Ensure main tab is properly activated
                    const mainTab = document.querySelector('.tab[data-tab-id="blueprint-main"]');
                    
                    if (mainTab && mainPane) {
                        // Remove active from all first
                        document.querySelectorAll('.tab, .tab-pane').forEach(el => {
                            el.classList.remove('active');
                        });
                        
                        // Force active state on main tab
                        mainTab.classList.add('active');
                        mainPane.classList.add('active');
                        activeTabId = 'blueprint-main';
                        
                        // Add click event listener to the main tab if not already added
                        if (!mainTab.hasAttribute('data-click-handler')) {
                            mainTab.addEventListener('click', function() {
                                activateTab('blueprint-main');
                            });
                            mainTab.setAttribute('data-click-handler', 'true');
                        }
                        
                        console.log('%c[Tab System] Main tab properly initialized and activated', 'color: #27ae60;');
                    } else {
                        console.error('%c[Tab System] Main tab elements not found', 'color: #e74c3c;');
                    }
                    
                    // Remove inline handlers to prevent conflicts
                    removeInlineHandlers();
                    
                    // Initialize the ScriptManager if available
                    if (window.ScriptManager && typeof window.ScriptManager.registerFunction === 'function') {
                        window.ScriptManager.registerFunction('viewVersionDetail', window.viewVersionDetail, true);
                        console.log('%c[Tab System] Registered viewVersionDetail with ScriptManager', 'color: #3498db;');
                    }
                    
                    // Restore tabs from session storage if available
                    setTimeout(() => {
                        restoreTabsFromSessionStorage();
                        // Final check to ensure main tab is active if no other tabs were restored
                        if (!document.querySelector('.tab.active')) {
                            activateTab('blueprint-main');
                        }
                    }, 100);
                    
                    console.log('%c[Tab System] Initialization complete', 'color: #27ae60;');
                };
                
                // Check if all required scripts are loaded
                const checkScriptsLoaded = () => {
                    const requiredFunctions = ['viewVersionDetail', 'createNewTab', 'activateTab'];
                    const loadedFunctions = requiredFunctions.filter(func => typeof window[func] === 'function');
                    
                    if (loadedFunctions.length === requiredFunctions.length) {
                        initializeTabSystem();
                    } else {
                        console.log('%c[Tab System] Waiting for scripts to load...', 'color: #e67e22;', 
                                  'Missing:', requiredFunctions.filter(func => typeof window[func] !== 'function'));
                        setTimeout(checkScriptsLoaded, 50);
                    }
                };
                
                checkScriptsLoaded();
            });
            
            // Additional page load event to ensure loading overlay is hidden
            window.addEventListener('load', function() {
                console.log('%c[Page] Page fully loaded, ensuring loading overlay is hidden', 'color: #2ecc71;');
                hideLoading();
                
                // Double-check main tab is active
                const mainTab = document.querySelector('.tab[data-tab-id="blueprint-main"]');
                const mainPane = document.getElementById('blueprint-main');
                if (mainTab && mainPane && !mainTab.classList.contains('active')) {
                    console.log('%c[Page] Fixing main tab activation after page load', 'color: #f39c12;');
                    activateTab('blueprint-main');
                }
            });
            
            // SPA Navigation Event Handlers
            document.addEventListener('spa:afterNavigation', function(e) {
                console.log('%c[Tab System] SPA navigation completed, reinitializing tab system', 'color: #3498db; font-weight: bold;');
                
                // Small delay to ensure DOM is updated
                setTimeout(() => {
                    // Hide loading overlay
                    hideLoading();
                    
                    // Reinitialize tab structure
                    ensureTabStructureIntegrity();
                    
                    // Ensure main tab is active if no other tabs are present
                    const activeTabs = document.querySelectorAll('.tab.active');
                    if (activeTabs.length === 0) {
                        console.log('%c[Tab System] No active tabs found, activating main tab', 'color: #f39c12;');
                        activateTab('blueprint-main');
                    }
                    
                    // Restore any previously opened tabs
                    restoreTabsFromSessionStorage();
                }, 100);
            });
            
            // Handle page visibility changes (for when user switches browser tabs)
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    // Page became visible, ensure loading overlay is hidden
                    hideLoading();
                }
            });
              // Function to save tabs to session storage
            window.saveTabsToSessionStorage = function() {
                const tabs = [];
                document.querySelectorAll('.tab').forEach(tab => {
                    const tabId = tab.getAttribute('data-tab-id');
                    if (tabId !== 'blueprint-main') {  // Don't need to save the main tab
                        const versionId = tab.getAttribute('data-version-id');
                        if (versionId) {
                            tabs.push({
                                tabId: tabId,
                                versionId: versionId
                            });
                        }
                    }
                });
                
                const tabState = {
                    tabs: tabs,
                    activeTabId: activeTabId
                };
                
                if (tabs.length > 0) {
                    sessionStorage.setItem('blueprint_tabs', JSON.stringify(tabState));
                    
                    // Also save to PageCache system if available
                    if (window.PageCache && typeof window.PageCache.setCustomState === 'function') {
                        window.PageCache.setCustomState('blueprint_tabs', tabState);
                        console.log('%c[Tab System] Saved tab state to PageCache', 'color: #27ae60;');
                    }
                } else {
                    sessionStorage.removeItem('blueprint_tabs');
                    
                    // Remove from PageCache if available
                    if (window.PageCache && typeof window.PageCache.removeCustomState === 'function') {
                        window.PageCache.removeCustomState('blueprint_tabs');
                    }
                }
            }
              // Function to restore tabs from session storage
            window.restoreTabsFromSessionStorage = function() {
                // First try to get from PageCache
                let tabState = null;
                if (window.PageCache && typeof window.PageCache.getCustomState === 'function') {
                    tabState = window.PageCache.getCustomState('blueprint_tabs');
                    if (tabState) {
                        console.log('%c[Tab System] Restored tab state from PageCache', 'color: #27ae60;');
                    }
                }
                
                // Fall back to session storage if not in PageCache
                if (!tabState) {
                    const savedData = sessionStorage.getItem('blueprint_tabs');
                    if (savedData) {
                        try {
                            tabState = JSON.parse(savedData);
                        } catch (error) {
                            console.error('Error parsing saved tab data:', error);
                            return;
                        }
                    }
                }
                
                if (tabState && tabState.tabs && tabState.tabs.length > 0) {
                    console.log('%c[Tab System] Restoring tabs:', 'color: #3498db;', tabState);
                    
                    // Restore each tab
                    tabState.tabs.forEach(savedTab => {
                        if (savedTab.versionId && savedTab.tabId) {
                            // Check if the tab already exists
                            const existingTab = document.querySelector(`.tab[data-tab-id="${savedTab.tabId}"]`);
                            if (!existingTab) {
                                console.log('%c[Tab System] Restoring tab:', 'color: #9b59b6;', savedTab.tabId);
                                // Trigger the creation of this tab
                                if (typeof window.viewVersionDetail === 'function') {
                                    setTimeout(() => {
                                        window.viewVersionDetail(savedTab.versionId);
                                    }, 100);
                                }
                            }
                        }
                    });
                    
                    // Activate the previously active tab if it exists and is not the main tab
                    if (tabState.activeTabId && tabState.activeTabId !== 'blueprint-main') {
                        setTimeout(() => {
                            const targetTab = document.querySelector(`.tab[data-tab-id="${tabState.activeTabId}"]`);
                            if (targetTab) {
                                activateTab(tabState.activeTabId);
                                console.log('%c[Tab System] Activated restored tab:', 'color: #e67e22;', tabState.activeTabId);
                            } else {
                                // If the target tab doesn't exist, ensure main tab is active
                                activateTab('blueprint-main');
                                console.log('%c[Tab System] Target tab not found, activating main tab', 'color: #f39c12;');
                            }
                        }, 200);
                    } else {
                        // Ensure main tab stays active if it was the active tab or no specific tab was active
                        setTimeout(() => {
                            activateTab('blueprint-main');
                            console.log('%c[Tab System] Keeping main tab active after restoration', 'color: #27ae60;');
                        }, 200);
                    }                } else {
                    console.log('%c[Tab System] No tabs to restore, main tab will remain active', 'color: #95a5a6;');
                    // Ensure main tab is active when no tabs are restored
                    activateTab('blueprint-main');
                }
            }
            
            // Override the viewFields function to open in a new tab
            function viewFields(versionId) {
                // Create a unique ID for this tab
                const tabId = 'fields-' + versionId;
                
                // Check if tab already exists
                const existingTab = document.querySelector(`.tab[data-tab-id="${tabId}"]`);
                if (existingTab) {
                    // Activate the existing tab instead of creating a new one
                    activateTab(tabId);
                    return;
                }
                
                // Show loading indicator
                showLoading(`Loading fields for version ${versionId}...`);
                
                // First, check if content is in the cache
                if (tabContentCache.has(tabId)) {
                    const cachedData = tabContentCache.get(tabId);
                    createNewTab(tabId, cachedData.title, cachedData.content, cachedData.icon, cachedData.versionId);
                    hideLoading();
                    
                    // Dispatch a custom event to let the app know a tab has been restored from cache
                    document.dispatchEvent(new CustomEvent('tab:restored', {
                        detail: { tabId, versionId }
                    }));
                    return;
                }
                  // Fetch the fields data
                fetch(`/blueprint-versions/${versionId}/fields`, {
                    headers: {
                        'Accept': 'text/html,application/xhtml+xml'
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Failed to load fields (Status: ${response.status})`);
                        }
                        return response.text();
                    })
                    .then(html => {
                        // Create a temporary div to parse the HTML
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        
                        // Extract the content we want (main content area)
                        const content = tempDiv.querySelector('[layout\\:fragment="content"]').innerHTML;
                        
                        // Extract the title
                        const title = tempDiv.querySelector('title').textContent || `Fields ${versionId}`;
                        
                        // Create and switch to the new tab
                        createNewTab(tabId, title, content, 'fa-list', versionId);
                        
                        // Cache the content
                        tabContentCache.set(tabId, {
                            title: title,
                            content: content,
                            icon: 'fa-list',
                            versionId: versionId,
                            timestamp: Date.now()
                        });
                        
                        // Hide loading indicator
                        hideLoading();
                        
                        // Initialize any scripts that the tab content might need
                        initializeTabScripts(tabId, versionId);
                          // Dispatch a custom event to let the app know a new tab has been created
                        document.dispatchEvent(new CustomEvent('tab:created', {
                            detail: { tabId, versionId }
                        }));
                        
                        // Save tabs state to session storage
                        saveTabsToSessionStorage();
                    })
                    .catch(error => {
                        console.error('Error loading fields:', error);
                        hideLoading();
                        showError('Failed to load fields. Please try again.');
                    });
            }            // Function to view version details in a tab - using fixed implementation
            if (typeof window.viewVersionDetail !== 'function') {
                window.viewVersionDetail = function(versionId) {
                    // Create a unique ID for this tab
                    const tabId = 'version-' + versionId;
                    
                    // Check if tab already exists
                    const existingTab = document.querySelector(`.tab[data-tab-id="${tabId}"]`);
                    if (existingTab) {
                        // Activate the existing tab instead of creating a new one
                        console.log('%c[Tab System] Tab already exists, activating:', 'color: #2980b9;', tabId);
                        activateTab(tabId);
                        return;
                    }
                    
                    console.log('%c[Tab System] Creating new tab for version:', 'color: #27ae60;', versionId);
                    
                    // Show loading indicator
                    showLoading(`Loading version details ${versionId}...`);
                    
                    // First, check if content is in the cache
                    if (tabContentCache.has(tabId)) {
                        const cachedData = tabContentCache.get(tabId);
                        createNewTab(tabId, cachedData.title, cachedData.content, cachedData.icon, cachedData.versionId);
                        hideLoading();
                        
                        // Dispatch a custom event to let the app know a tab has been restored from cache
                        document.dispatchEvent(new CustomEvent('tab:restored', {
                            detail: { tabId, versionId }
                        }));
                        return;
                    }
                    
                    // Fetch the version details data from the API
                    fetch(`/api/blueprint-versions/${versionId}`, {
                        headers: {
                            'Accept': 'application/json'
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Failed to load version details (Status: ${response.status})`);
                        }
                        return response.json(); // Parse JSON response
                    })
                    .then(data => {
                        // Format the details in HTML
                        const content = `
                            <div class="container mt-4">
                                <div class="card">
                                    <div class="card-header bg-dark text-white">
                                        <h5 class="mb-0">Version Details</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-4">
                                            <div class="col-md-6">
                                                <h5>Version Information</h5>
                                                <table class="table table-sm">
                                                    <tr>
                                                        <th style="width: 150px">Version Number:</th>
                                                        <td>${data.versionNumber || 'N/A'}</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Name:</th>
                                                        <td>${data.name || 'N/A'}</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Description:</th>
                                                        <td>${data.description || 'N/A'}</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Status:</th>
                                                        <td>
                                                            <span class="badge ${data.active ? 'bg-success' : 'bg-secondary'}">
                                                                ${data.active ? 'Active' : 'Inactive'}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </table>
                                            </div>
                                            <div class="col-md-6">
                                                <h5>Metadata</h5>
                                                <table class="table table-sm">
                                                    <tr>
                                                        <th style="width: 150px">Created By:</th>
                                                        <td>${data.createdBy || 'N/A'}</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Created At:</th>
                                                        <td>${new Date(data.createdAt || data.createdDate).toLocaleString()}</td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-12">
                                                <h5>Actions</h5>
                                                <div class="btn-group">
                                                    <button onclick="viewFields(${data.id})" class="btn btn-primary">
                                                        <i class="fas fa-list me-1"></i> View Fields
                                                    </button>
                                                    ${!data.active ? `
                                                        <button onclick="activateVersion(${data.id})" class="btn btn-success">
                                                            <i class="fas fa-check me-1"></i> Activate Version
                                                        </button>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Set the title
                        const title = `Version ${data.versionNumber}: ${data.name}`;
                        
                        // Create and switch to the new tab
                        createNewTab(tabId, title, content, 'fa-info-circle', versionId);
                        
                        // Cache the content
                        tabContentCache.set(tabId, {
                            title: title,
                            content: content,
                            icon: 'fa-info-circle',
                            versionId: versionId,
                            timestamp: Date.now()
                        });
                        
                        // Hide loading indicator
                        hideLoading();
                        
                        // Initialize any scripts that the tab content might need
                        initializeTabScripts(tabId, versionId);
                          // Dispatch a custom event to let the app know a new tab has been created
                        document.dispatchEvent(new CustomEvent('tab:created', {
                            detail: { tabId, versionId }
                        }));
                        
                        // Save tabs state to session storage
                        saveTabsToSessionStorage();
                    })                    .catch(error => {
                        console.error('Error loading version details:', error);
                        hideLoading();
                        
                        // Create a fallback version details view with error message
                        const errorContent = `
                            <div class="container mt-4">
                                <div class="alert alert-danger">
                                    <h4 class="alert-heading">Error Loading Version Details</h4>
                                    <p>${error.message}</p>
                                    <hr>
                                    <p class="mb-0">Please try again or contact support if the problem persists.</p>
                                </div>
                                <div class="card bg-dark">
                                    <div class="card-header">
                                        <h5 class="mb-0">Version ${versionId} Details</h5>
                                    </div>
                                    <div class="card-body">
                                        <p>Unable to load details at this time.</p>
                                        <button class="btn btn-primary" onclick="viewVersionDetail(${versionId})">
                                            <i class="fas fa-sync-alt me-1"></i> Retry
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Create and switch to the new tab even if there was an error
                        const tabId = 'version-' + versionId;
                        const title = `Version ${versionId} (Error)`;
                        createNewTab(tabId, title, errorContent, 'fa-exclamation-circle', versionId);
                          // Show error message as a toast/alert
                        showError('Failed to load version details. Please try again.');
                    });
                }
            }
            
            // Add window beforeunload event listener to save tab state
            window.addEventListener('beforeunload', function() {
                console.log('%c[Tab System] Saving tab state before page unload', 'color: #e74c3c;');
                saveTabsToSessionStorage();
            });
            
            // Add listener for SPA navigation events if available
            document.addEventListener('spa:beforeNavigation', function() {
                console.log('%c[Tab System] Saving tab state before SPA navigation', 'color: #3498db;');
                saveTabsToSessionStorage();
            });
              // Use ONLY event delegation for all view-fields-btn buttons
            // This prevents duplicate event handlers
            const processedButtons = new Set();

            // Remove any inline onclick attributes from buttons that should use our event delegation
            function removeInlineHandlers() {
                document.querySelectorAll('.view-fields-btn[onclick]').forEach(button => {
                    if (!processedButtons.has(button)) {
                        processedButtons.add(button);
                        // Remove the onclick attribute
                        button.removeAttribute('onclick');
                        
                        // Update the icon if needed
                        const icon = button.querySelector('i');
                        if (icon && (!icon.className.includes('fa-info-circle'))) {
                            icon.className = 'fas fa-info-circle';
                        }
                        
                        console.log('%c[Tab System] Removed inline handler from button:', 'color: #9b59b6;', button);
                    }
                });
            }
            
            // Call this whenever new content is added to the DOM
            document.addEventListener('DOMContentLoaded', removeInlineHandlers);
            document.addEventListener('tab:created', removeInlineHandlers);
            document.addEventListener('tab:restored', removeInlineHandlers);
            document.addEventListener('versions:loaded', removeInlineHandlers);
              // Enhanced event delegation with debouncing to prevent duplicate calls
            let lastClickTime = 0;
            let lastClickedVersionId = null;
            const CLICK_DEBOUNCE_MS = 1000; // Prevent multiple clicks within 1 second
            
            // Use a single event delegation handler for all buttons
            document.addEventListener('click', function(e) {
                const button = e.target.closest('.view-fields-btn');
                if (button) {
                    e.preventDefault();
                    e.stopPropagation(); // Prevent event bubbling
                    e.stopImmediatePropagation(); // Prevent other listeners
                    
                    const versionId = button.getAttribute('data-id');
                    if (versionId) {
                        const currentTime = Date.now();
                        const parsedVersionId = parseInt(versionId, 10);
                        
                        // Debounce: Prevent rapid successive clicks on the same version
                        if (lastClickedVersionId === parsedVersionId && 
                            (currentTime - lastClickTime) < CLICK_DEBOUNCE_MS) {
                            console.log('%c[Tab System] Ignoring rapid successive click for version:', 'color: #e74c3c;', parsedVersionId);
                            return;
                        }
                        
                        lastClickTime = currentTime;
                        lastClickedVersionId = parsedVersionId;
                        
                        // Disable the button temporarily to prevent additional clicks
                        const originalText = button.innerHTML;
                        button.disabled = true;
                        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                        
                        try {
                            console.log('%c[Tab System] Click handler via delegation for version:', 'color: #f39c12;', parsedVersionId);
                            
                            // Use the deduplicated function
                            if (typeof window.viewVersionDetail === 'function') {
                                window.viewVersionDetail(parsedVersionId);
                            } else {
                                console.error('%c[Tab System] viewVersionDetail function not available', 'color: #e74c3c;');
                            }
                            
                            // Re-enable button after a delay
                            setTimeout(() => {
                                button.disabled = false;
                                button.innerHTML = originalText;
                            }, 1000);
                            
                        } catch (error) {
                            console.error('Error handling button click:', error);
                            button.disabled = false;
                            button.innerHTML = originalText;
                            hideLoading(); // Make sure loading overlay is hidden in case of error
                            showError('An error occurred: ' + error.message);
                        }
                    }
                }
            });
        </script>
        
        <!-- Global debugging command for manual inspection -->
        <script>
            // Make debugging commands globally available for manual testing
            window.debugBlueprints = function() {
                console.log('%c============ MANUAL BLUEPRINT DEBUG ============', 'color: #e74c3c; font-weight: bold; font-size: 16px;');
                  if (window.BlueprintTabManager) {
                    window.BlueprintTabManager.debugDOMStructure('Manual Debug Call');
                    window.BlueprintTabManager.diagnoseCSSIssues('Manual Debug Call');
                    window.BlueprintTabManager.performTimingAnalysis();
                    
                    console.log('%c[Manual Debug] Available commands:', 'color: #3498db; font-weight: bold;');
                    console.log('  debugBlueprints() - Run this debug analysis');
                    console.log('  fixBlueprints() - Attempt to fix tab structure');
                    console.log('  diagnoseCSSBlueprints() - Analyze CSS styling issues');
                    console.log('  BlueprintTabManager.validateAndRepairTabStructure() - Repair structure');
                    console.log('  BlueprintTabManager.activateMainTab() - Activate main tab');
                    console.log('  BlueprintTabManager.debugDOMStructure(context) - Inspect DOM');
                    console.log('  BlueprintTabManager.diagnoseCSSIssues(context) - Analyze CSS');
                } else {
                    console.error('%c[Manual Debug] BlueprintTabManager not available!', 'color: #e74c3c; font-weight: bold;');
                }
                
                console.log('%c===============================================', 'color: #e74c3c; font-weight: bold; font-size: 16px;');
            };
            
            window.fixBlueprints = function() {
                console.log('%c============ MANUAL BLUEPRINT FIX ============', 'color: #27ae60; font-weight: bold; font-size: 16px;');
                
                if (window.BlueprintTabManager) {
                    console.log('%c[Manual Fix] Starting repair process...', 'color: #27ae60; font-weight: bold;');
                    
                    const success = window.BlueprintTabManager.validateAndRepairTabStructure();
                    if (success) {
                        window.BlueprintTabManager.activateMainTab();
                        console.log('%c[Manual Fix] ‚úÖ Repair completed successfully!', 'color: #27ae60; font-weight: bold;');
                    } else {
                        console.log('%c[Manual Fix] ‚ùå Repair failed!', 'color: #e74c3c; font-weight: bold;');
                    }
                    
                    window.BlueprintTabManager.debugDOMStructure('After Manual Fix');
                } else {
                    console.error('%c[Manual Fix] BlueprintTabManager not available!', 'color: #e74c3c; font-weight: bold;');
                }
                  console.log('%c=============================================', 'color: #27ae60; font-weight: bold; font-size: 16px;');
            };
            
            window.diagnoseCSSBlueprints = function() {
                console.log('%c============ MANUAL CSS DIAGNOSTIC ============', 'color: #8e44ad; font-weight: bold; font-size: 16px;');
                
                if (window.BlueprintTabManager) {
                    console.log('%c[Manual CSS] Analyzing tab styling...', 'color: #8e44ad; font-weight: bold;');
                    window.BlueprintTabManager.diagnoseCSSIssues('Manual CSS Diagnostic');
                } else {
                    console.error('%c[Manual CSS] BlueprintTabManager not available!', 'color: #e74c3c; font-weight: bold;');
                }
                
                console.log('%c===============================================', 'color: #8e44ad; font-weight: bold; font-size: 16px;');            };
            
            // Auto-announce debugging commands
            setTimeout(() => {
                console.log('%cüí° Blueprint Debugging Commands Available:', 'color: #9b59b6; font-weight: bold;');
                console.log('%c   debugBlueprints() - Analyze current tab structure', 'color: #9b59b6;');
                console.log('%c   fixBlueprints() - Attempt to fix tab header issues', 'color: #9b59b6;');
                console.log('%c   diagnoseCSSBlueprints() - Analyze CSS styling issues', 'color: #9b59b6;');
            }, 2000);
        </script>
    </div>
</body>
</html>
